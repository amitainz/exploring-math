<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troll Time(s) Table - Fixed Pad</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: monospace;
            padding: 20px;
            /* Add padding to bottom so the fixed keypad doesn't hide content */
            padding-bottom: 280px;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h3 { margin-top: 0; }

        /* --- TIMELINE STYLES --- */
        .container {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            min-height: 120px;
            margin-bottom: 0;
        }

        .column {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 3px;
            width: 25px;
            flex-shrink: 0;
            position: relative; /* Essential for the overlay to position correctly */
            border-radius: 4px;
        }

        .label {
            height: 50px;
            width: 25px;
            position: relative;
            margin-bottom: 10px;
            z-index: 1;
        }

        .label span {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            white-space: nowrap;
            font-size: 11px;
            color: #555;
        }

        .square {
            width: 20px;
            height: 20px;
            border: 1px solid #ddd;
            margin-bottom: 4px;
            background-color: #f0f0f0;
            transition: background-color 0.3s;
            position: relative;
            z-index: 1;
        }

        .purple-active {
            background-color: #9b59b6 !important;
            border-color: #8e44ad;
            box-shadow: 0 0 5px #9b59b6;
        }

        .green-active {
            background-color: #2ecc71 !important;
            border-color: #27ae60;
            box-shadow: 0 0 5px #2ecc71;
        }

        /* The Yellow Highlight Overlay */
        .column-highlight {
            position: absolute;
            /* Center marker over the column */
            top: -2px; bottom: -2px; left: -2px; right: -2px;
            width: auto; height: auto;

            background-color: rgba(255, 240, 0, 1);
            mix-blend-mode: multiply; /* The "Marker" effect */
            z-index: 10; /* Ensures it sits on top */

            border-radius: 6px;
            pointer-events: none;
            border: 2px solid rgba(220, 200, 0, 0.5);
            padding: 0;
        }

        /* --- SELECTION PANELS (SCROLLABLE AREA) --- */
        .selection-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }

        .troll-row {
            display: flex;
            gap: 20px;
        }

        .troll-panel {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
        }

        /* Yellow Panel Specifics */
        .panel-yellow {
            border-color: #f1c40f;
        }
        .troll-btn {
            padding: 10px 20px;
            font-family: monospace;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid #333;
            background: #fff;
            margin-bottom: 10px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
        }

        /* Button Colors */
        #btn-left { border-color: #9b59b6; color: #9b59b6; }
        #btn-left.selected { background-color: #9b59b6; color: white; }

        #btn-right { border-color: #2ecc71; color: #27ae60; }
        #btn-right.selected { background-color: #2ecc71; color: white; }

        #btn-center { border-color: #f1c40f; color: #d4ac0d; }
        #btn-center.selected { background-color: #f1c40f; color: black; }


        .troll-text {
            font-size: 13px;
            text-align: center;
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        .troll-text.alive { opacity: 1; font-weight: bold; }

        /* --- FIXED KEYPAD (BOTTOM) --- */
        .control-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #e0e0e0;
            border-top: 4px solid #333;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .control-center {
            background: #333;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            gap: 20px;
            width: 95%;
            max-width: 1100px;
        }

        .timeline-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .control-question {
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-align: right;
            flex: 1;
            line-height: 1.4;
        }

        .keypad-stack {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .digital-display {
            background-color: #000;
            color: #0f0;
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            padding: 15px;
            border: 4px solid #555;
            border-radius: 5px;
            width: 140px;
            text-align: center;
            letter-spacing: 2px;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.2);
        }

        @keyframes shudder {
            0% { transform: translateX(0); border-color: #f00; color: #f00; }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); border-color: #555; color: #0f0; }
        }

        .shuddering {
            animation: shudder 0.4s ease-in-out;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .key {
            width: 45px;
            height: 40px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 3px 0 #222;
            transition: all 0.1s;
        }

        .key:active, .key.active-press {
            transform: translateY(3px);
            box-shadow: 0 0 0 #222;
            background-color: #666;
        }

        .key-enter { background-color: #2ecc71; color: #000; }
        .key-clear { background-color: #e74c3c; color: white; }

        /* --- VICTORY OVERLAY --- */
        #victory-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            justify-content: center; align-items: center; cursor: pointer;
        }

    </style>
</head>
<body>

    <img src="trolls_and_gates.png" style="max-width: 60%; height: auto; margin-bottom: 10px;" alt="Gates">
    <h3>The Gatekeepers' Schedule</h3>

    <div class="selection-area">

        <div class="troll-row">
            <div class="troll-panel">
                <button id="btn-right" class="troll-btn">Green Troll</button>
                <div id="text-right" class="troll-text">
                    Opens his gate at multiples of 4 minutes. Can you list all of the times in the next hour?
                </div>
            </div>

            <div class="troll-panel">
                <button id="btn-left" class="troll-btn">Purple Troll</button>
                <div id="text-left" class="troll-text">
                    Opens his gate at multiples of 3 minutes. Can you list all of the times in the next hour?
                </div>
            </div>
        </div>

        <div class="troll-panel panel-yellow">
            <button id="btn-center" class="troll-btn">Plan the run to the palace</button>
            <div id="text-center" class="troll-text">
                What are <em>all</em> the times both gates are open?
            </div>

            <button id="btn-done" class="troll-btn" style="margin-top: 15px; border-color: #333; color: #333;">All done</button>
            <div id="done-error" style="color: red; font-size: 11px; margin-top: 5px; min-height: 15px; text-align: center;"></div>
        </div>

        <div class="troll-panel" style="border-color: #ccc;">
            <strong style="margin-bottom: 10px; display: block;">BONUS: Chopin's Fantasie Impromptu</strong>
            <div>
                As you listen to this beautiful piece by Frederic Chopin, take a look at the score
                (even if you don't know how to read music!) and let your mind wonder:
                How could that <em>possibly</em> be related to the 3 and 4 times tables?
            </div>
            <br>
            <iframe width="560" height="315" src="https://www.youtube.com/embed/WEZKKf3Df-4?si=T_udkt3QrhJ6oWsx" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            <br>
            <div>
                Hint: Count the number of notes the right hand (on the top) and the left hand (on the bottom) are
                playing in the bar shown below. Does that remind you of what the two trolls are doing with their gates?
            </div>
            <br>
            <img src="impromp2.jpg" style="max-width: 60%; height: auto; margin-bottom: 10px;" alt="Chopin">
            <br>
            <div>
                This 4-3 "polyrhythm" makes for a very distinctive, dynamic sensation.
                With a bit of practice, you can learn how to tap this rhythm with your hands, as the following video
                will teach you. It will make you appreciate what that pianist is doing even more!
            </div>
            <br>
            <iframe width="560" height="315" src="https://www.youtube.com/embed/_37pioTK_gA?si=BMWcp-Z4h-4zEQs5" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            <br>

            <div>
    <p style="margin-bottom: 15px;">
        One final "note"...
        The video is set up so the <strong style="color: #27ae60; font-weight: bold;">left hand</strong> (or troll!) shown
        at the bottom beats at <span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 4px; font-family: monospace;">1, 5, and 9</span>.
    </p>
    <p style="margin-bottom: 15px;">
        The <strong style="color: #9b59b6; font-weight: bold;">right hand</strong> beats at <span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 4px; font-family: monospace;">1, 4, 7 and 10</span>.
    </p>
    <p style="font-style: italic; color: #555; margin-bottom: 15px;">
        If this feels a bit "off" to you, simply renumber the beats to be
        <strong>0, 1, 2, ..., 11</strong> instead of 1, 2, ..., 12. This way,
    </p>
    <ul style="list-style-type: disc; margin-left: 20px; margin-bottom: 15px;">
        <li>The <strong>left hand</strong> beats at <span style="color: #27ae60; font-weight: bold;">0, 4, and 8</span></li>
        <li>The <strong>right hand</strong> beats at <span style="color: #9b59b6; font-weight: bold;">0, 3, 6 and 9</span></li>
    </ul>
    <p style="font-weight: bold;">
        Much better, right?
    </p>
</div>
        </div>

    </div>


    <div class="control-wrapper">
        <div class="control-center">
            <div class="timeline-group">
                <div class="control-question" id="active-question-display">
                    Select a question above...
                </div>
                <div class="container" id="timeline"></div>
            </div>
            
            <div class="keypad-stack">
                <div class="digital-display" id="display">4:00</div>
                <div class="keypad">
                    <button class="key" data-val="1" onclick="pressKey(1)">1</button>
                    <button class="key" data-val="2" onclick="pressKey(2)">2</button>
                    <button class="key" data-val="3" onclick="pressKey(3)">3</button>
                    <button class="key" data-val="4" onclick="pressKey(4)">4</button>
                    <button class="key" data-val="5" onclick="pressKey(5)">5</button>
                    <button class="key" data-val="6" onclick="pressKey(6)">6</button>
                    <button class="key" data-val="7" onclick="pressKey(7)">7</button>
                    <button class="key" data-val="8" onclick="pressKey(8)">8</button>
                    <button class="key" data-val="9" onclick="pressKey(9)">9</button>
                    <button class="key key-clear" data-val="C" onclick="pressKey('C')">C</button>
                    <button class="key" data-val="0" onclick="pressKey(0)">0</button>
        </div>
    </div>

    <div id="victory-overlay">
        <img src="welcome_home_w_banner.png" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px white;" alt="Welcome Home">
    </div>

    <script>
        // State variables
        let activeTroll = null;
        let currentInput = "";
        let hasPlayedLeft = false;
        let hasPlayedRight = false;
        let hasPlayedCenter = false;

        document.addEventListener("DOMContentLoaded", function() {
            generateTimeline();
            setupButtons();
            setupVictory();
            setupKeyboardSupport();
        });

        // --- KEYBOARD SUPPORT ---
        function setupKeyboardSupport() {
            document.addEventListener('keydown', function(event) {
                let keyVal = null;
                if (event.key >= '0' && event.key <= '9') {
                    keyVal = parseInt(event.key);
                } else if (event.key === 'Enter') {
                    keyVal = 'E';
                    event.preventDefault();
                } else if (event.key === 'Escape') {
                    keyVal = 'C';
                    event.preventDefault();
                }

                if (keyVal !== null) {
                    pressKey(keyVal);
                    animateButton(keyVal);
                }
            });
        }

        function animateButton(val) {
            const btn = document.querySelector(`.key[data-val="${val}"]`);
            if (btn) {
                btn.classList.add('active-press');
                setTimeout(() => { btn.classList.remove('active-press'); }, 100);
            }
        }

        // --- TIMELINE GENERATION ---
        function generateTimeline() {
            const container = document.getElementById('timeline');
            container.innerHTML = '';

            for (let i = 0; i <= 59; i++) {
                const col = document.createElement('div');
                col.className = 'column';
                col.id = `col-${i}`; // ID to find the column for highlighting

                const labelDiv = document.createElement('div');
                labelDiv.className = 'label';
                const labelSpan = document.createElement('span');
                let hour = 4;
                let minute = i;
                if (i === 60) { hour = 5; minute = 0; }
                labelSpan.innerText = `${hour}:${minute.toString().padStart(2, '0')}`;
                labelDiv.appendChild(labelSpan);
                col.appendChild(labelDiv);

                const sqPurple = document.createElement('div');
                sqPurple.className = 'square';
                sqPurple.id = `purple-sq-${i}`;
                col.appendChild(sqPurple);

                const sqGreen = document.createElement('div');
                sqGreen.className = 'square';
                sqGreen.id = `green-sq-${i}`;
                col.appendChild(sqGreen);

                container.appendChild(col);
            }
        }

        // --- SELECTION LOGIC ---
        function setupButtons() {
            const btnLeft = document.getElementById('btn-left');
            const btnRight = document.getElementById('btn-right');
            const btnCenter = document.getElementById('btn-center');

            const txtLeft = document.getElementById('text-left');
            const txtRight = document.getElementById('text-right');
            const txtCenter = document.getElementById('text-center');
            const questionDisplay = document.getElementById('active-question-display');

            function updateQuestion(title, text, color) {
                questionDisplay.innerHTML = `<strong style="color: ${color}; font-size: 24px; display: block; margin-bottom: 8px;">${title}</strong>${text}`;
            }

            function clearSelection() {
                // Clear UI states
                btnLeft.classList.remove('selected');
                btnRight.classList.remove('selected');
                btnCenter.classList.remove('selected');

                txtLeft.classList.remove('alive');
                txtRight.classList.remove('alive');
                txtCenter.classList.remove('alive');

                document.getElementById('done-error').innerText = "";
                resetDisplay();
            }

            btnLeft.addEventListener('click', () => {
                clearSelection();
                if (!hasPlayedLeft) {
                    new Audio('troll_2_every_3.mp3').play();
                    hasPlayedLeft = true;
                }
                activeTroll = 'purple';
                btnLeft.classList.add('selected');
                txtLeft.classList.add('alive');
                updateQuestion(btnLeft.innerText, txtLeft.innerText, '#9b59b6');
            });

            btnRight.addEventListener('click', () => {
                clearSelection();
                if (!hasPlayedRight) {
                    new Audio('troll_1_every_4.mp3').play();
                    hasPlayedRight = true;
                }
                activeTroll = 'green';
                btnRight.classList.add('selected');
                txtRight.classList.add('alive');
                updateQuestion(btnRight.innerText, txtRight.innerText, '#2ecc71');
            });

            btnCenter.addEventListener('click', () => {
                clearSelection();
                if (!hasPlayedCenter) {
                    new Audio('girl_getting_home.mp3').play();
                    hasPlayedCenter = true;
                }
                activeTroll = 'yellow';
                btnCenter.classList.add('selected');
                txtCenter.classList.add('alive');
                updateQuestion(btnCenter.innerText, txtCenter.innerText, '#f1c40f');
            });
        }

        // --- KEYPAD LOGIC ---
        function pressKey(key) {
            if (key === 'C') { resetDisplay(); return; }
            if (key === 'E') { submitTime(); return; }
            if (currentInput.length < 2) {
                currentInput += key;
                updateDisplay();
            }
        }

        function updateDisplay() {
            // Pad logic: "" -> "00", "3" -> "03", "35" -> "35"
            let displayMins = currentInput === "" ? "00" : (currentInput.length === 1 ? "0" + currentInput : currentInput);
            document.getElementById('display').innerText = `4:${displayMins}`;
        }

        function resetDisplay() {
            currentInput = "";
            const display = document.getElementById('display');
            display.innerText = "4:00";
            display.classList.remove('shuddering');
        }

        function triggerShudder() {
            const display = document.getElementById('display');
            display.classList.remove('shuddering');
            void display.offsetWidth;
            display.classList.add('shuddering');
            setTimeout(resetDisplay, 500);
        }

        // --- VICTORY LOGIC ---
        function setupVictory() {
            const overlay = document.getElementById('victory-overlay');
            const errDiv = document.getElementById('done-error');

            document.getElementById('btn-done').addEventListener('click', () => {
                const targets = [0, 12, 24, 36, 48];
                const allFound = targets.every(t => {
                    const col = document.getElementById(`col-${t}`);
                    return col && col.querySelector('.column-highlight');
                });

                if (allFound) {
                    overlay.style.display = 'flex';
                    errDiv.innerText = "";
                } else {
                    errDiv.innerText = "there's at least one opportunity to make a run for it which you've missed";
                    errDiv.classList.remove('shuddering');
                    void errDiv.offsetWidth;
                    errDiv.classList.add('shuddering');
                }
            });
            overlay.addEventListener('click', () => { overlay.style.display = 'none'; });
        }

        // --- GAME LOGIC ---
        function submitTime() {
            if (!activeTroll) {
                alert("Please select a Plan first!");
                return;
            }

            const minute = parseInt(currentInput);

            if (isNaN(minute) || minute < 0 || minute > 60) {
                triggerShudder();
                return;
            }

            let isCorrect = false;

            // 1. PURPLE LOGIC
            if (activeTroll === 'purple') {
                if (minute % 3 === 0) {
                    const sq = document.getElementById(`purple-sq-${minute}`);
                    if(sq) {
                        sq.classList.add('purple-active');
                        sq.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        isCorrect = true;
                    }
                }
            }
            // 2. GREEN LOGIC
            else if (activeTroll === 'green') {
                if (minute % 4 === 0) {
                    const sq = document.getElementById(`green-sq-${minute}`);
                    if(sq) {
                        sq.classList.add('green-active');
                        sq.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        isCorrect = true;
                    }
                }
            }
            // 3. YELLOW LOGIC (Plan the run)
            else if (activeTroll === 'yellow') {
                if (minute % 12 === 0) {
                    const col = document.getElementById(`col-${minute}`);
                    if(col) {
                        // Check if highlight already exists to avoid duplicates
                        if (!col.querySelector('.column-highlight')) {
                            const highlight = document.createElement('div');
                            highlight.className = 'column-highlight';
                            col.appendChild(highlight);
                        }
                        document.getElementById('done-error').innerText = "";

                        col.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        isCorrect = true;
                    }
                }
            }

            if (isCorrect) {
                resetDisplay();
            } else {
                triggerShudder();
            }
        }
    </script>
</body>
</html>